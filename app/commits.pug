doctype html
html
  head
    title= 'Deploy'
    link(href='//cdn.bootcss.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css' rel='stylesheet')
    link(href='//cdn.bootcss.com/material-design-icons/3.0.1/iconfont/material-icons.min.css' rel='stylesheet')
    style(type='text/css').
      .navbar {
        margin-bottom: 20px
      }
      .table td {
        vertical-align: middle
      }
  body
    nav.navbar.navbar-light.bg-faded
      h1.navbar-brand.mb-0 Deploy
    div.container-fluid
      div.row
        div.col
          table.table.table-bordered
            tbody
              each commit in commits
                tr
                  td
                    - var url = `https://github.com/Bill0106/${commit.repo}/commit/${commit.commit_id}`
                    a(href=url target='_blank')= commit.commit_id.substr(0, 8)
                  td= commit.commit_message
                  td= `${commit.committer_name} <${commit.committer_email}>`
                  td= commit.committedAt
                  td= (commit.dist_files || 'Waiting')
                  td
                    button.btn.btn-primary.btn-sm(type='button' data-deploy-build=commit._id)
                      i.material-icons build
    div#buildModal.modal.fade
      div.modal-dialog.modal-lg(role='document')
        div.modal-content
          div.modal-header
            h5.modal-title Commit Building...
            button.close(type='button' data-dismiss='modal' aria-label='Close')
              span(aria-hidden='true') &times;
          div.modal-body
            div.alert.alert-danger(role='alert' style='display: none' data-deploy='error')
            pre
              code(data-deploy-log)

    script(src='//cdn.bootcss.com/tether/1.4.0/js/tether.min.js' type='text/javascript')
    script(src='//cdn.bootcss.com/jquery/3.2.1/jquery.min.js' type='text/javascript')
    script(src='//cdn.bootcss.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js' type='text/javascript')
    script(src='//cdn.bootcss.com/socket.io/2.0.3/socket.io.slim.js' type='text/javascript')
    script.
      $(document).ready(function() {
        const socket = io.connect('http://192.168.33.10:3000')
        socket.on('error', error => {
          $("[data-deploy='error']").text(error).show()
        })
        socket.on('log', log => {
          $("[data-deploy-log]").append(log)
        })

        $("[data-deploy-build]").click(function() {
          const id = $(this).data('deploy-build')
          socket.emit('build', { id })
          $("#buildModal").modal('show')
        })
      })
